<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.lug.ustc.edu.cn/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|40:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Mysql,JDBC,批量导入,SSM,项目经验," />





  <link rel="alternate" href="/atom.xml" title="King哥" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="引言 在做一个项目的时候，涉及到需要从一个表格中获取百万条数据然后插入到数据库中，最后采用JDBC的executeBantch方法实现这个功能。   采取的策略 尽量关闭字段索引（因为再插入数据的时候还是需要维护索引的，在创建索引和维护索引 会耗费时间,随着数据量的增加而增加，可以在插入数据后再去为字段创建索引）  虽然索引可以提高查询速度但是，插入数据的时候会导致索性的更新。索性越多，插入会越慢">
<meta name="keywords" content="Mysql,JDBC,批量导入,SSM,项目经验">
<meta property="og:type" content="article">
<meta property="og:title" content="实现多数据量的导入数据库">
<meta property="og:url" content="http://kingge.top/2017/08/01/实现多数据量的导入数据库/index.html">
<meta property="og:site_name" content="King哥">
<meta property="og:description" content="引言 在做一个项目的时候，涉及到需要从一个表格中获取百万条数据然后插入到数据库中，最后采用JDBC的executeBantch方法实现这个功能。   采取的策略 尽量关闭字段索引（因为再插入数据的时候还是需要维护索引的，在创建索引和维护索引 会耗费时间,随着数据量的增加而增加，可以在插入数据后再去为字段创建索引）  虽然索引可以提高查询速度但是，插入数据的时候会导致索性的更新。索性越多，插入会越慢">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-08-17T08:21:15.695Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="实现多数据量的导入数据库">
<meta name="twitter:description" content="引言 在做一个项目的时候，涉及到需要从一个表格中获取百万条数据然后插入到数据库中，最后采用JDBC的executeBantch方法实现这个功能。   采取的策略 尽量关闭字段索引（因为再插入数据的时候还是需要维护索引的，在创建索引和维护索引 会耗费时间,随着数据量的增加而增加，可以在插入数据后再去为字段创建索引）  虽然索引可以提高查询速度但是，插入数据的时候会导致索性的更新。索性越多，插入会越慢">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"hide","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://kingge.top/2017/08/01/实现多数据量的导入数据库/"/>





  <title>实现多数据量的导入数据库 | King哥</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-hide page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">King哥</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">To know everything, no words don't talk, listening to people is enough to cause alarm（知无不言，言无不尽 言者无罪，闻者足戒）</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-picture">
          <a href="/picture/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-camera"></i> <br />
            
            照片
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://kingge.top/2017/08/01/实现多数据量的导入数据库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jeremy Kinge">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="King哥">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">实现多数据量的导入数据库</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-01T14:37:15+08:00">
                2017-08-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JDBC/" itemprop="url" rel="index">
                    <span itemprop="name">JDBC</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><blockquote>
<p>在做一个项目的时候，涉及到需要从一个表格中获取百万条数据然后插入到数据库中，最后采用JDBC的executeBantch方法实现这个功能。</p>
</blockquote>
<hr>
<h2 id="采取的策略"><a href="#采取的策略" class="headerlink" title="采取的策略"></a>采取的策略</h2><ul>
<li><p>尽量关闭字段<a href="/2016/08/01/Mysql索引详解"><strong><em>索引</em></strong></a>（因为再插入数据的时候还是需要维护索引的，在创建索引和维护索引 会耗费时间,随着数据量的增加而增加，可以在插入数据后再去为字段创建索引）</p>
<blockquote>
<p>虽然索引可以提高查询速度但是，插入数据的时候会导致索性的更新。索性越多，插入会越慢。可以看文档描述:<br>Although it can be tempting to create an indexes for every possible column used in a query, unnecessary indexes waste space and waste time for MySQL to determine which indexes to use. Indexes also add to the cost of inserts, updates, and deletes because each index must be updated. You must find the right balance to achieve fast queries using the optimal set of indexes.</p>
</blockquote>
</li>
<li><p>分批次提交数据</p>
</li>
<li><p>在分布式条件下，还可以考虑在不同的数据库结点提交，有底层的消息系统完成数据扩展</p>
</li>
<li>过滤预处理数据<blockquote>
<p>预处理数据的场景：为了避免插入的数据（假设ListA）跟数据库中某些数据重复，那么我们会把要插入的数据去数据库中查询是否已经存在，获得返回的已经存在数据（ListB）。然后在插入数据的时候判断当前数据是否在ListB中，那么当前数据不能够插入数据库。过滤出来，最后得到一个可以插入数据库的ListC</p>
</blockquote>
</li>
</ul>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><h2 id="关键代码"><a href="#关键代码" class="headerlink" title="关键代码"></a>关键代码</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/*数据分析结束*/</span></div><div class="line">     <span class="comment">/*往数据库写数据开始*/</span></div><div class="line">     Connection conn=<span class="keyword">null</span>;</div><div class="line">     PreparedStatement idsUserAdd=<span class="keyword">null</span>;</div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">         Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>) ;</div><div class="line">         conn = DriverManager.getConnection(ConfigTool.getProperty(<span class="string">"jdbc.url"</span>).toString() , ConfigTool.getProperty(<span class="string">"jdbc.username"</span>).toString() , ConfigTool.getProperty(<span class="string">"jdbc.password"</span>).toString());</div><div class="line">         conn.setAutoCommit(<span class="keyword">false</span>);</div><div class="line">         <span class="comment">//构造预处理statement</span></div><div class="line">         idsUserAdd = conn.prepareStatement(<span class="string">"INSERT INTO dc_matedata ("</span>+</div><div class="line">       		  <span class="string">" ID,`NAME`, DATATYPE,`CODE`,TYPE_ID,`LENGTH`, "</span>+</div><div class="line">       		  <span class="string">" DATANAME, VALUEAREA,`RESTRICT`, REMARK,MD_DATE)"</span>+</div><div class="line">       		  <span class="string">" values(?,?,?,?,?,?,?,?,?,?,now())"</span>);</div><div class="line">        <span class="comment">//最大列表的数目当做循环次数</span></div><div class="line">         <span class="keyword">int</span> xhcs=addMetadataList.size();<span class="comment">//addMetadataList需要插入的数据</span></div><div class="line">         <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;xhcs;i++)&#123;</div><div class="line">                 idsUserAdd.setString(<span class="number">1</span>,addMetadataList.get(i).get(<span class="string">"id"</span>).toString());</div><div class="line">                 idsUserAdd.setString(<span class="number">2</span>,addMetadataList.get(i).get(<span class="string">"name"</span>).toString());</div><div class="line">                 idsUserAdd.setString(<span class="number">3</span>,addMetadataList.get(i).get(<span class="string">"dataType"</span>).toString());</div><div class="line">                 idsUserAdd.setString(<span class="number">4</span>,addMetadataList.get(i).get(<span class="string">"code"</span>).toString());</div><div class="line">                 idsUserAdd.setString(<span class="number">5</span>,addMetadataList.get(i).get(<span class="string">"typeId"</span>).toString());</div><div class="line">                 idsUserAdd.setString(<span class="number">6</span>,addMetadataList.get(i).get(<span class="string">"dataLength"</span>).toString());</div><div class="line">                 idsUserAdd.setString(<span class="number">7</span>,addMetadataList.get(i).get(<span class="string">"dataName"</span>).toString());</div><div class="line">                 idsUserAdd.setString(<span class="number">8</span>,addMetadataList.get(i).get(<span class="string">"valueArea"</span>).toString());</div><div class="line">                 idsUserAdd.setString(<span class="number">9</span>,addMetadataList.get(i).get(<span class="string">"dataRestrict"</span>).toString());</div><div class="line">                 idsUserAdd.setString(<span class="number">10</span>,addMetadataList.get(i).get(<span class="string">"dataRemark"</span>).toString());</div><div class="line">                 idsUserAdd.addBatch();</div><div class="line">                 </div><div class="line">             <span class="comment">//每10000次提交一次</span></div><div class="line">             <span class="keyword">if</span>(i%<span class="number">10000</span>==<span class="number">0</span>||i==xhcs-<span class="number">1</span>)&#123;<span class="comment">//可以设置不同的大小；如50，100，500，1000等等 i==xhcs-1（最后一次）</span></div><div class="line">                 idsUserAdd.executeBatch();</div><div class="line">                 conn.commit();</div><div class="line">                 idsUserAdd.clearBatch();</div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line"></div><div class="line">     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">         e.printStackTrace();</div><div class="line">         <span class="keyword">throw</span>  e;</div><div class="line">     &#125;<span class="keyword">finally</span> &#123;</div><div class="line">         <span class="keyword">try</span> &#123;</div><div class="line">             <span class="keyword">if</span>(idsUserAdd!=<span class="keyword">null</span>)</div><div class="line">                 idsUserAdd.close();</div><div class="line">             <span class="keyword">if</span>(conn!=<span class="keyword">null</span>)</div><div class="line">                 conn.close();</div><div class="line">         &#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">             e.printStackTrace();</div><div class="line">             <span class="keyword">throw</span>  e;</div><div class="line">         &#125;</div><div class="line"></div><div class="line">     &#125;</div><div class="line">     <span class="comment">/*往数据库写数据结束*/</span></div></pre></td></tr></table></figure>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">   * 校验需要导入的元数据信息，封装错误信息并批量插入数据库</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; saveDCMetadataBatch(List&lt;Map&lt;String, Object&gt;&gt; list,  <span class="keyword">boolean</span> valid,</div><div class="line">          <span class="keyword">boolean</span> addError) <span class="keyword">throws</span> Exception&#123;</div><div class="line">      </div><div class="line">      List&lt;Map&lt;String,Object&gt;&gt; errorList=<span class="keyword">new</span> ArrayList&lt;Map&lt;String,Object&gt;&gt;();<span class="comment">//获得不能够添加成功的数据</span></div><div class="line">      Map&lt;String,Object&gt; map=<span class="keyword">new</span> HashMap&lt;String,Object&gt;();<span class="comment">//查询条件</span></div><div class="line">      Map&lt;String,String&gt; codeMap=<span class="keyword">new</span> HashMap&lt;String,String&gt;();<span class="comment">//每个分类对应的元数据的编号最大值</span></div><div class="line">      Map&lt;String,Object&gt; metaName=<span class="keyword">new</span> HashMap&lt;String,Object&gt;();<span class="comment">//查询数据库中是否存在相同的数据（这里校验的是：元数据的中文简称）</span></div><div class="line">      Map&lt;String,Object&gt; metaDataName=<span class="keyword">new</span> HashMap&lt;String,Object&gt;();<span class="comment">//查询数据库中是否存在相同的数据（这里校验的是：元数据的数据项名称）</span></div><div class="line">      </div><div class="line">      map.put(<span class="string">"metaName"</span>,list);<span class="comment">//需要查询的元数据中文名称</span></div><div class="line">      map.put(<span class="string">"metaDataTypeId"</span>,list);<span class="comment">//导入的元数据的编号</span></div><div class="line">      List&lt;Map&lt;String, Object&gt;&gt; metaExistList = dCMatedataDao.getDCMetadata(map);<span class="comment">//根据元数据名称查询当前分类下是否存在同样元数据</span></div><div class="line">      map.put(<span class="string">"metaName"</span>,<span class="keyword">null</span>);<span class="comment">//置空</span></div><div class="line">      </div><div class="line">      map.put(<span class="string">"metaDataName"</span>,list);</div><div class="line">      List&lt;Map&lt;String, Object&gt;&gt; metaExistListTwo = dCMatedataDao.getDCMetadata(map);<span class="comment">//根据元数据数据项名称查询存在的元数据</span></div><div class="line">      </div><div class="line">      <span class="comment">//保存重复的信息</span></div><div class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;metaExistList.size();i++)</div><div class="line">          metaName.put(metaExistList.get(i).get(<span class="string">"name"</span>).toString()+metaExistList.get(i).get(<span class="string">"code"</span>).toString()</div><div class="line">                  ,metaExistList.get(i).get(<span class="string">"id"</span>));<span class="comment">//添加父类的编号为后缀-唯一性保证</span></div><div class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;metaExistListTwo.size();i++)</div><div class="line">          metaDataName.put(metaExistListTwo.get(i).get(<span class="string">"dataname"</span>).toString()+metaExistListTwo.get(i).get(<span class="string">"code"</span>).toString(),</div><div class="line">                  metaExistListTwo.get(i).get(<span class="string">"id"</span>));</div><div class="line">      </div><div class="line">      </div><div class="line">      <span class="comment">/*整理出来的数据-开始*/</span></div><div class="line">      List&lt;Map&lt;String,Object&gt;&gt; addMetadataList=<span class="keyword">new</span> ArrayList&lt;Map&lt;String,Object&gt;&gt;();</div><div class="line">      </div><div class="line">      <span class="comment">/*整理出来的数据-结束*/</span></div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.size(); i++) &#123;</div><div class="line">          Map&lt;String, Object&gt; MetadataObj = list.get(i);</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              String metadatId = StringUtil.getUUID();<span class="comment">//元数据id</span></div><div class="line">                  <span class="comment">/*校验开始*/</span></div><div class="line">              <span class="keyword">if</span> (valid)&#123;</div><div class="line">                  <span class="keyword">if</span>(validUser(MetadataObj,<span class="string">"name"</span>,addError)!=<span class="keyword">null</span>)&#123;<span class="comment">//验证输入的数据是否符合格式和必填。</span></div><div class="line">                      errorList.add(MetadataObj);</div><div class="line">                      <span class="keyword">continue</span>;</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">              <span class="comment">/*前端校验结束*/</span></div><div class="line">              <span class="comment">/*校验是否存在同名的元数据*/</span></div><div class="line">              String dataCodeCheck = MetadataObj.get(<span class="string">"dataCode"</span>).toString().trim();      <span class="comment">//元数据父分类编号</span></div><div class="line">              String name = MetadataObj.get(<span class="string">"name"</span>).toString().trim();<span class="comment">//元数据中文简称</span></div><div class="line">                  <span class="keyword">if</span> (metaName.containsKey(name+dataCodeCheck)) &#123;</div><div class="line"></div><div class="line">                      <span class="keyword">if</span> (addError) &#123;</div><div class="line">                          MetadataObj.put(<span class="string">"errInfo"</span>, <span class="string">"中文简称已存在"</span>);</div><div class="line">                      &#125;</div><div class="line">                      errorList.add(MetadataObj);</div><div class="line">                      <span class="keyword">continue</span>;</div><div class="line">                  &#125;</div><div class="line">                  <span class="comment">/*校验是否存在相同数据项的元数据*/</span></div><div class="line">                  String dataName = MetadataObj.get(<span class="string">"dataName"</span>).toString().trim();<span class="comment">//数据项名</span></div><div class="line">                  <span class="keyword">if</span> (metaDataName.containsKey(dataName+dataCodeCheck)) &#123;</div><div class="line">                      </div><div class="line">                      <span class="keyword">if</span> (addError) &#123;</div><div class="line">                          MetadataObj.put(<span class="string">"errInfo"</span>, <span class="string">"数据项名已存在"</span>);</div><div class="line">                      &#125;</div><div class="line">                      errorList.add(MetadataObj);</div><div class="line">                      <span class="keyword">continue</span>;</div><div class="line">                  &#125;</div><div class="line">                  </div><div class="line">                  String dataCode = MetadataObj.get(<span class="string">"dataCode"</span>).toString().trim();      <span class="comment">//元数据父分类编号</span></div><div class="line">                  List&lt;Map&lt;String, Object&gt;&gt; footCount = dCMatedataDao.getFootCount(dataCode);</div><div class="line">                  <span class="keyword">if</span>( footCount.size() &gt; <span class="number">0</span>)&#123;</div><div class="line">                      <span class="keyword">if</span> (addError) &#123;</div><div class="line">                          MetadataObj.put(<span class="string">"errInfo"</span>, <span class="string">"分类编码不是最后一级分类"</span>);</div><div class="line">                      &#125;</div><div class="line">                      errorList.add(MetadataObj);</div><div class="line">                      <span class="keyword">continue</span>;</div><div class="line">                  &#125;</div><div class="line">                   Map&lt;String, Object&gt; typeByCode = dCMatedataDao.getMetadataTypeByCode(dataCode);</div><div class="line">                  <span class="keyword">if</span>( typeByCode == <span class="keyword">null</span> || typeByCode.size() &lt; <span class="number">1</span>)&#123;</div><div class="line">                      <span class="keyword">if</span> (addError) &#123;</div><div class="line">                          MetadataObj.put(<span class="string">"errInfo"</span>, <span class="string">"分类编码不存在，请先添加分类"</span>);</div><div class="line">                      &#125;</div><div class="line">                      errorList.add(MetadataObj);</div><div class="line">                      <span class="keyword">continue</span>;</div><div class="line">                  &#125;</div><div class="line">                  <span class="comment">//校验是在添加的List中是否存在相同的数据项名或者中文简称</span></div><div class="line">                  <span class="comment">//校验导入文件中是否存在一样的中文简称或者数据项名</span></div><div class="line">                  <span class="keyword">boolean</span> nameExist = <span class="keyword">false</span>;</div><div class="line">                  <span class="keyword">boolean</span> dataNameExist = <span class="keyword">false</span>;</div><div class="line">                  <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; addMetadataList.size(); j++)&#123;</div><div class="line">                      Map&lt;String, Object&gt; map2 = addMetadataList.get(j);</div><div class="line">                      String typeId = map2.get(<span class="string">"typeId"</span>).toString();</div><div class="line">                      String nameE = map2.get(<span class="string">"name"</span>).toString();</div><div class="line">                      String dataNameE = map2.get(<span class="string">"dataName"</span>).toString();</div><div class="line">                      <span class="keyword">if</span>( typeId.equals(typeByCode.get(<span class="string">"id"</span>).toString()) &amp;&amp; nameE.equals(name))&#123;</div><div class="line">                          nameExist=<span class="keyword">true</span>;</div><div class="line">                          <span class="keyword">break</span>;</div><div class="line">                      &#125;</div><div class="line">                      <span class="keyword">if</span>( typeId.equals(typeByCode.get(<span class="string">"id"</span>).toString()) &amp;&amp; dataNameE.equals(dataName))&#123;</div><div class="line">                          dataNameExist=<span class="keyword">true</span>;</div><div class="line">                          <span class="keyword">break</span>;</div><div class="line">                      &#125;</div><div class="line">                   </div><div class="line">               &#125;</div><div class="line">                  <span class="keyword">if</span>( nameExist )&#123;</div><div class="line">                      <span class="keyword">if</span> (addError) &#123;</div><div class="line">                          MetadataObj.put(<span class="string">"errInfo"</span>, <span class="string">"中文简称已存在"</span>);</div><div class="line">                      &#125;</div><div class="line">                      errorList.add(MetadataObj);</div><div class="line">                      <span class="keyword">continue</span>;</div><div class="line">                  &#125;</div><div class="line">                  <span class="keyword">if</span>( dataNameExist )&#123;</div><div class="line">                      <span class="keyword">if</span> (addError) &#123;</div><div class="line">                          MetadataObj.put(<span class="string">"errInfo"</span>, <span class="string">"数据项名已存在"</span>);</div><div class="line">                      &#125;</div><div class="line">                      errorList.add(MetadataObj);</div><div class="line">                      <span class="keyword">continue</span>;</div><div class="line">                  &#125;</div><div class="line">                  </div><div class="line">                 <span class="comment">//进入这里说明校验结束，开始填充添加的数据</span></div><div class="line">                  String type_id = typeByCode.get(<span class="string">"id"</span>).toString();<span class="comment">//元数据所属分类id</span></div><div class="line">                  String dataType =  MetadataObj.get(<span class="string">"dataType"</span>).toString().trim();      <span class="comment">//元数据类型</span></div><div class="line">                  String dataLength =  MetadataObj.get(<span class="string">"dataLength"</span>).toString().trim();      <span class="comment">//元数据长度</span></div><div class="line">                  String code  = <span class="string">""</span>;</div><div class="line">                  <span class="comment">////</span></div><div class="line">                  <span class="keyword">if</span>( codeMap.get(dataCode) == <span class="keyword">null</span>||StringUtil.isEmpty(codeMap.get(dataCode)) )&#123;<span class="comment">//表示当前分类不存在已经添加的元数据--因为编码map中不存在对应分类的最大编码</span></div><div class="line">                      </div><div class="line">                      Map maxCodeByPid = <span class="keyword">this</span>.selectMetadataMaxCode(type_id);</div><div class="line">                      <span class="keyword">if</span>( maxCodeByPid == <span class="keyword">null</span> )&#123;<span class="comment">//表示当前分类下不存在任何子分类</span></div><div class="line">                          code =  StringUtil.getCode(<span class="string">"0"</span>, dataCode);<span class="comment">//则从01开始编号</span></div><div class="line">                          codeMap.put(dataCode, <span class="string">"01"</span>);<span class="comment">//保存当前分类下元数据编号最大值</span></div><div class="line">                      &#125;<span class="keyword">else</span>&#123;</div><div class="line">                          String object = (String) maxCodeByPid.get(<span class="string">"codeNum"</span>);<span class="comment">//当前分类节点下的元数据的编号最大值。</span></div><div class="line">                          <span class="keyword">int</span> pSituation = object.indexOf(dataCode);</div><div class="line">                          <span class="keyword">int</span> pLength =   pSituation+dataCode.length() ;</div><div class="line">                          String substring = object.substring(pLength); <span class="comment">//截取出最大编号值得最大值</span></div><div class="line">                          code = StringUtil.getCode(substring, dataCode);</div><div class="line">                          </div><div class="line">                          <span class="keyword">int</span> temp = Integer.parseInt(substring);<span class="comment">//保存当前分类下元数据编号最大值</span></div><div class="line">                          temp+=<span class="number">1</span>;</div><div class="line">                          codeMap.put(dataCode, temp+<span class="string">""</span>);</div><div class="line">                      &#125;</div><div class="line">                  &#125;<span class="keyword">else</span>&#123;</div><div class="line">                      String maxCode = codeMap.get(dataCode);</div><div class="line">                      code = StringUtil.getCode(maxCode, dataCode);</div><div class="line">                      <span class="comment">//保存当前分类下元数据编号最大值</span></div><div class="line">                      <span class="keyword">int</span> temp = Integer.parseInt(maxCode);</div><div class="line">                      temp+=<span class="number">1</span>;</div><div class="line">                      codeMap.put(dataCode, temp+<span class="string">""</span>);</div><div class="line">                  &#125;</div><div class="line">                      </div><div class="line">                  <span class="comment">///</span></div><div class="line">                  Map&lt;String, Object&gt; metadatList = <span class="keyword">new</span> LinkedHashMap&lt;String, Object&gt;();</div><div class="line">                  metadatList.put(<span class="string">"id"</span>, metadatId);</div><div class="line">                  metadatList.put(<span class="string">"name"</span>,name);</div><div class="line">                  metadatList.put(<span class="string">"dataType"</span>,dataType);</div><div class="line">                  metadatList.put(<span class="string">"code"</span>,code);</div><div class="line">                  metadatList.put(<span class="string">"typeId"</span>,type_id);</div><div class="line">                  metadatList.put(<span class="string">"dataLength"</span>,dataLength);</div><div class="line">                  metadatList.put(<span class="string">"dataName"</span>,dataName);</div><div class="line">                  metadatList.put(<span class="string">"valueArea"</span>, MetadataObj.get(<span class="string">"valueArea"</span>)==<span class="keyword">null</span>?<span class="string">""</span>:MetadataObj.get(<span class="string">"valueArea"</span>) );</div><div class="line">                  metadatList.put(<span class="string">"dataRestrict"</span>,MetadataObj.get(<span class="string">"dataRestrict"</span>)==<span class="keyword">null</span>?<span class="string">""</span>:MetadataObj.get(<span class="string">"dataRestrict"</span>));</div><div class="line">                  metadatList.put(<span class="string">"dataRemark"</span>,MetadataObj.get(<span class="string">"dataRemark"</span>)==<span class="keyword">null</span>?<span class="string">""</span>:MetadataObj.get(<span class="string">"dataRemark"</span>));</div><div class="line">                  metadatList.put(<span class="string">"mdDate"</span>,<span class="keyword">new</span> Date());</div><div class="line">                  </div><div class="line">                  addMetadataList.add(metadatList);</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">catch</span> (Exception e)&#123;</div><div class="line">              <span class="keyword">if</span>(addError) &#123;</div><div class="line">                  MetadataObj.put(<span class="string">"errInfo"</span>, e.getMessage());</div><div class="line">              &#125;</div><div class="line">              errorList.add(MetadataObj);</div><div class="line"></div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">/*数据分析结束*/</span></div><div class="line">     <span class="comment">/*往数据库写数据开始*/</span></div><div class="line">     Connection conn=<span class="keyword">null</span>;</div><div class="line">     PreparedStatement idsUserAdd=<span class="keyword">null</span>;</div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">         Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>) ;</div><div class="line">         conn = DriverManager.getConnection(ConfigTool.getProperty(<span class="string">"jdbc.url"</span>).toString() , ConfigTool.getProperty(<span class="string">"jdbc.username"</span>).toString() , ConfigTool.getProperty(<span class="string">"jdbc.password"</span>).toString());</div><div class="line">         conn.setAutoCommit(<span class="keyword">false</span>);</div><div class="line">         <span class="comment">//构造预处理statement</span></div><div class="line">         idsUserAdd = conn.prepareStatement(<span class="string">"INSERT INTO dc_matedata ("</span>+</div><div class="line">       		  <span class="string">" ID,`NAME`, DATATYPE,`CODE`,TYPE_ID,`LENGTH`, "</span>+</div><div class="line">       		  <span class="string">" DATANAME, VALUEAREA,`RESTRICT`, REMARK,MD_DATE)"</span>+</div><div class="line">       		  <span class="string">" values(?,?,?,?,?,?,?,?,?,?,now())"</span>);</div><div class="line">        <span class="comment">//最大列表的数目当做循环次数</span></div><div class="line">         <span class="keyword">int</span> xhcs=addMetadataList.size();</div><div class="line">         <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;xhcs;i++)&#123;</div><div class="line">                 idsUserAdd.setString(<span class="number">1</span>,addMetadataList.get(i).get(<span class="string">"id"</span>).toString());</div><div class="line">                 idsUserAdd.setString(<span class="number">2</span>,addMetadataList.get(i).get(<span class="string">"name"</span>).toString());</div><div class="line">                 idsUserAdd.setString(<span class="number">3</span>,addMetadataList.get(i).get(<span class="string">"dataType"</span>).toString());</div><div class="line">                 idsUserAdd.setString(<span class="number">4</span>,addMetadataList.get(i).get(<span class="string">"code"</span>).toString());</div><div class="line">                 idsUserAdd.setString(<span class="number">5</span>,addMetadataList.get(i).get(<span class="string">"typeId"</span>).toString());</div><div class="line">                 idsUserAdd.setString(<span class="number">6</span>,addMetadataList.get(i).get(<span class="string">"dataLength"</span>).toString());</div><div class="line">                 idsUserAdd.setString(<span class="number">7</span>,addMetadataList.get(i).get(<span class="string">"dataName"</span>).toString());</div><div class="line">                 idsUserAdd.setString(<span class="number">8</span>,addMetadataList.get(i).get(<span class="string">"valueArea"</span>).toString());</div><div class="line">                 idsUserAdd.setString(<span class="number">9</span>,addMetadataList.get(i).get(<span class="string">"dataRestrict"</span>).toString());</div><div class="line">                 idsUserAdd.setString(<span class="number">10</span>,addMetadataList.get(i).get(<span class="string">"dataRemark"</span>).toString());</div><div class="line">                 idsUserAdd.addBatch();</div><div class="line">                 </div><div class="line">             <span class="comment">//每10000次提交一次</span></div><div class="line">             <span class="keyword">if</span>(i%<span class="number">10000</span>==<span class="number">0</span>||i==xhcs-<span class="number">1</span>)&#123;<span class="comment">//可以设置不同的大小；如50，100，500，1000等等</span></div><div class="line">                 idsUserAdd.executeBatch();</div><div class="line">                 conn.commit();</div><div class="line">                 idsUserAdd.clearBatch();</div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line"></div><div class="line">     &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">         e.printStackTrace();</div><div class="line">         <span class="keyword">throw</span>  e;</div><div class="line">     &#125;<span class="keyword">finally</span> &#123;</div><div class="line">         <span class="keyword">try</span> &#123;</div><div class="line">             <span class="keyword">if</span>(idsUserAdd!=<span class="keyword">null</span>)</div><div class="line">                 idsUserAdd.close();</div><div class="line">             <span class="keyword">if</span>(conn!=<span class="keyword">null</span>)</div><div class="line">                 conn.close();</div><div class="line">         &#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">             e.printStackTrace();</div><div class="line">             <span class="keyword">throw</span>  e;</div><div class="line">         &#125;</div><div class="line"></div><div class="line">     &#125;</div><div class="line">     <span class="comment">/*往数据库写数据结束*/</span></div><div class="line"></div><div class="line">      </div><div class="line">   <span class="keyword">return</span> errorList;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><blockquote>
<p>有些网友发现使用StringBuffer 来拼接入参，不通过prepareStatement的预处理，虽然前者速度很快，但是使用prepareStatement可以防止SQL注入</p>
</blockquote>
<hr>
<blockquote>
<p>有的好的建议大家都可以提出来</p>
</blockquote>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>如果你感觉文章对你又些许感悟，你可以支持我！！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/uploads/wechatpay.png" alt="Jeremy Kinge WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/uploads/alipay.png" alt="Jeremy Kinge Alipay"/>
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Mysql/" rel="tag"># Mysql</a>
          
            <a href="/tags/JDBC/" rel="tag"># JDBC</a>
          
            <a href="/tags/批量导入/" rel="tag"># 批量导入</a>
          
            <a href="/tags/SSM/" rel="tag"># SSM</a>
          
            <a href="/tags/项目经验/" rel="tag"># 项目经验</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/21/Java工程师书单（初级、中级、高级）/" rel="next" title="Java工程师书单（初级、中级、高级）">
                <i class="fa fa-chevron-left"></i> Java工程师书单（初级、中级、高级）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/08/14/Hessian 多系统访问/" rel="prev" title="Hessian 多系统访问">
                Hessian 多系统访问 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.png"
               alt="Jeremy Kinge" />
          <p class="site-author-name" itemprop="name">Jeremy Kinge</p>
           
              <p class="site-description motion-element" itemprop="description">To know everything, no words don't talk, listening to people is enough to cause alarm（知无不言，言无不尽 言者无罪，闻者足戒）</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/JeremyKinge" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/LJBANANABLUE?s=09" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                    
                      Twitter
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://m.weibo.cn/u/3991058874?from=1078095010&wm=20005_0002&sourceType=qq&uid=3991058874" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/profile.php?id=100010100689349" target="_blank" title="FB Page">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                    
                      FB Page
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/your-user-name" target="_blank" title="StackOverflow">
                  
                    <i class="fa fa-fw fa-stack-overflow"></i>
                  
                    
                      StackOverflow
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#引言"><span class="nav-number">1.</span> <span class="nav-text">引言</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#采取的策略"><span class="nav-number">1.1.</span> <span class="nav-text">采取的策略</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#代码"><span class="nav-number">2.</span> <span class="nav-text">代码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#关键代码"><span class="nav-number">2.1.</span> <span class="nav-text">关键代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#完整代码"><span class="nav-number">2.2.</span> <span class="nav-text">完整代码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2022 &mdash; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jeremy Kinge</span>

  
</div>


  <div class="powered-by">
    由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
  </div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">
    主题 &mdash;
    <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
      NexT.Mist
    </a>
  </div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  



  
  









  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>

  
  <script type="text/javascript" src="/lib/three/three.min.js"></script>

  
  <script type="text/javascript" src="/lib/three/three-waves.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
